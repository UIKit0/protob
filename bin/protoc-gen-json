#!/usr/bin/env node
var Compiler = require('../lib/compiler').Compiler;
var registry = Compiler.compileDescriptors([]);
var Util = require('util');
var singleFile = process.env.SINGLE_FILE;

var ByteBuffer = require('bytebuffer');

var buffer = new ByteBuffer(undefined, true);

process.stdin.on("data", function(data) {
  buffer.append(ByteBuffer.wrap(data));
});

process.stdin.on("end", function(){
  buffer.flip();

  var Request  = registry.lookup("google.protobuf.compiler.CodeGeneratorRequest"),
      Response = registry.lookup("google.protobuf.compiler.CodeGeneratorResponse"),
      File     = registry.lookup("google.protobuf.compiler.CodeGeneratorResponse"),
      request  = Request.decode(buffer.copy(), null, {});

  // Need to ensure that we have all extensions present and compiled before decoding
  request.getf('proto_file').forEach(function(file) {
    Compiler.compileDescriptor(file);
  });

  // Re-Read the buffer to make sure we've got all the extensions
  request = Request.decode(buffer.copy(), null, {});

  var response = new Response();
  var singleFiles = [], fileSet;
  response.file = [];

  request.getf('proto_file').forEach(function(file){
    var f = new File()
    if(singleFile) {
      singleFiles.push(file.asJSON({fieldsAsNumber: true}));
    } else {
      f.setf(file.getf('name').replace(/\.proto$/, '.json'), 'name');
      f.setf(JSON.stringify([file.asJSON({fieldsAsNumbers: true})], null, 2), 'content');
      response.getf('file').push(f);
    }
  });

  if(singleFiles.length) {
    var file = new File();
    file.setf(singleFile, 'name');
    file.setf(JSON.stringify(singleFiles), 'content');
    response.setf([file], 'file');
  }

  var result = response.encode().toBuffer();
  process.stdout.write(result);
});


process.stdin.resume();
